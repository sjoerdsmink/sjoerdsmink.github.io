<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Beacon Test</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
    	.panel-title {
	    	font-size: 75px;
    	}
    	
    	.forgotBlock {
	    	margin-top: 10px;
	    	margin-bottom: 0px;
    	}
    	
    	.panel-body {
	    	display: none;
    	}
    	
    	.panel-heading {
	    	cursor: pointer;
    	}
    </style>
</head>
<body>


<div class="container-fluid">
    <h1>Beacon Test
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#explainModal">
	        Uitleg of meedoen aan deze test?
	    </button>
        <button type="button" class="btn btn-default pull-right" onclick="queryParse();">
            <span class="glyphicon glyphicon-refresh"></span>
        </button>
    </h1>
    <hr />
    <div class="row">
        <div class="col-md-6">
            <h2>Uitgang</h2>
            <div id="uitgangPanels" class="panels"></div>
        </div>
        <div class="col-md-6">
            <h2>Station</h2>
            <div id="stationPanels" class="panels"></div>
        </div>
    </div>
</div>


<!-- Explain Modal -->
<div class="modal fade" id="explainModal" tabindex="-1" role="dialog" aria-labelledby="explainModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="explainModalLabel">Be-In Be-Out / Beacon Test</h4>
			</div>
			<div class="modal-body">
				...
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Sluiten</button>
			</div>
		</div>
	</div>
</div>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>

<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
<script type="text/javascript">
    Parse.initialize("5dqmuyoqmkt6RdiOEciz8BjOgVh9cgVlCwcj07WY", "n2xbsECQDu8d68CwBntUmFwDtENTaz7nnc75dyuq");
    queryParse();
    //setInterval(queryParse, 1000);


    function queryParse() {
        var measurementObject = Parse.Object.extend("ClosestMeasurement");
        // get ClosestMeasurement for all users
        var query = new Parse.Query(measurementObject);
        //query.equalTo("status", "ENTER");
        //query.descending("updatedAt");
        //query.limit(10);
        /*today = new Date();
        today.setMinutes(today.getMinutes()-15);
        query.greaterThan("createdAt", today.toISOString());*/
        query.find({
            success: function(results) {
                console.log("retrieved "+ results.length +" objects from ClosestMeasurement");
                
                namesForLocation = {};
                // Do something with the returned Parse.Object values
                for (var i = 0; i < results.length; i++) {
                    var object = results[i];
                    getNamesForLocation(object);
                    //writeRow(object);
                }
                writeNamesInTable();
                updateForgot();
                enableExpandPanels();
            },
            error: function(error) {
                alert("Error: " + error.code + " " + error.message);
            }
        });
    }
    
    var namesForLocation;
    function getNamesForLocation(data) {
	    var name = data.get('user');
	    if (!namesForLocation.hasOwnProperty(name)) {
		    // new name
		    namesForLocation[name] = data;
		}
    }

    function writeNamesInTable() {
	    console.log(namesForLocation);
	    
	    $("#uitgangPanels").html('');
	    $("#stationPanels").html('');
	    
	    for (var nameKey in namesForLocation) {
		    var measurement = namesForLocation[nameKey];
		    console.log(measurement);
		    if (measurement.get('minor') == '10') {
			    writeRow("uitgangPanels", measurement);
		    } else if (measurement.get('minor') == '11') {
			    writeRow("stationPanels", measurement);
		    }
		}
    }
    function writeRow(htmlBlock, measurement) {
        var html = '' +
                '<div class="panel panel-primary">' +
                '   <div class="panel-heading">' +
                '       <h3 class="panel-title">'+ measurement.get('user') +'</h3>' +
                '   </div>' +
                '   <div class="panel-body">' +
                '       ' + measurement.createdAt +'<br />' +
                '		Screen: '+ measurement.get('screenStatus') +' - ' +
                '		Platform: '+ measurement.get('platform') +
                '   </div>' +
                '</div>';
        $("#"+ htmlBlock).append(html);
    }
    
    /**
      * Set "Vergeten in/uit te checken" in panel
      */
    function updateForgot() {
	    $(".forgotBlock").remove();
	    
	    var cicoStatusObject = Parse.Object.extend("CicoStatus");
        // get CicoStatus for all users
        var query = new Parse.Query(cicoStatusObject);
        query.find({
            success: function(results) {
                console.log("retrieved "+ results.length +" objects from CicoStatus");
                for (var i = 0; i < results.length; i++) {
                    var cicoStatus = results[i];
                    $(".panel .panel-title").each(function() {
	                    if ($(this).text() == cicoStatus.get('user')) {
		                    // found panel of user -> check for forgot block
			                expectedCheckin = $(this).closest(".panels").attr("id") == "stationPanels";
			                actualCheckin = cicoStatus.get('status') == "ingecheckt";
			                if (expectedCheckin != actualCheckin) {
				                // show forgot block
				                forgotHtml = '<p class="forgotBlock"><span class="label label-danger">Vergeten ';
				                forgotHtml += expectedCheckin ? 'in' : 'uit';
				                forgotHtml += ' te checken</span></p>';
				                $(this).parent().append(forgotHtml);
			                }
	                    }
                    })
                }
            },
            error: function(error) {
                alert("Error in requesting CicoStatus: " + error.code + " " + error.message);
            }
        });
    }
    
    function enableExpandPanels() {
	    $(".panel-heading").click(function() {
		    $(this).parent().find(".panel-body").toggle();
	    });
    }
    
    $(document).ready(function() {
	    
	    
	});
    
</script>

</body>
</html>